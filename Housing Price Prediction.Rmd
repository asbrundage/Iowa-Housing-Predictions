---
title: "Home Prices"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## setup

```{r cars}
library(tidyverse)
library(forecast)
library(lubridate)
library(recipes)
library(corrplot)
library(scales)
library(ranger)
library(randomForest)
library(purrr)
library(knitr)
```

## Including Plots

You can also embed plots, for example:

```{r}
train <- read.csv("C:/Users/asbru/Documents/Emory/Forecasting and Predictive Analytics/Final/house-prices-advanced-regression-techniques/train.csv", stringsAsFactors = FALSE)

test <- read.csv("C:/Users/asbru/Documents/Emory/Forecasting and Predictive Analytics/Final/house-prices-advanced-regression-techniques/train.csv", stringsAsFactors = FALSE)

fullset <- 
  train %>% 
  bind_rows(test) %>% 
  rowid_to_column("ID") %>% 
  select(-Id) %>% 
  rename(Id = ID) %>% 
  mutate_if(is.character,as.factor) 



```

##Cleanup

```{r}
#Find NA Values
navalues <- as.data.frame(map_df(fullset, function(x) sum(is.na(x)))) 

#View Columns with NA Values
NATable <-
  navalues %>% 
  pivot_longer(colnames(navalues), names_to = "ColName", values_to = "NA_Count") %>% 
  filter(NA_Count > 0)
NATable %>% 
  kable()

#Replace NA values for "None" for variables where NA actually means the house does not have the trait
fullset <- 
  train %>% 
  bind_rows(test) %>% 
  rowid_to_column("ID") %>% 
  select(-Id) %>% 
  rename(Id = ID) %>% 
  mutate_at(vars(Alley,BsmtQual,BsmtCond,BsmtExposure,BsmtFinType1,BsmtFinType2,FireplaceQu,GarageType,GarageFinish,GarageQual,GarageCond,PoolQC,Fence), ~replace(., is.na(.), "None")) %>% 
  mutate_if(is.character,as.factor) 


```


##Use Recipe to prepare data for model

```{r}
trainv2 <-
  train %>% 
  select(Id,SalePrice,LotArea,Neighborhood,Utilities,LotConfig,HouseStyle,BldgType,OverallQual,OverallCond,YearBuilt,YearRemodAdd,BsmtFinType1,BsmtFinType2,BsmtFinSF1,BsmtFinSF2,BsmtUnfSF,TotalBsmtSF) %>% 
  mutate(age = 2020 - YearBuilt) %>% 
  mutate_at(vars(BsmtFinType2,BsmtFinType1), ~replace_na(., 0))
  # mutate(age = as.numeric(year(date()))-as.numeric(YearBuilt))

# Create model recipe
recipe1 <-
  recipe(SalePrice ~ ., data = trainv2)

recipe1steps <-
  recipe1 %>% 
  step_dummy(Neighborhood,Utilities,LotConfig,HouseStyle,BldgType,BsmtFinType1,BsmtFinType2) 

preppedrecipe1 <- prep(recipe1steps, training = trainv2)

trainbaked1 <-
  bake(preppedrecipe1,trainv2)



```

##EDA

```{r}
Saleshist<-
  trainv2 %>% 
  ggplot(aes(x = SalePrice, fill = Neighborhood)) +
  geom_histogram() +
  scale_x_continuous(labels = comma) +
  facet_wrap(~Neighborhood)
Saleshist

bldgtypebox <-
  trainv2 %>% 
  ggplot(aes(x = BldgType, y = SalePrice)) +
  geom_boxplot()

bldgtypebox

bsmttypebox <-
  trainv2 %>% 
  ggplot(aes(x = BldgType, y = SalePrice)) +
  geom_boxplot()


correlation <-
  trainbaked1 
 
M <- 
  cor(correlation)
# png(file="corr.png", res=300, width=4500, height=4500)
corrplot(M, method = "shade", number.cex = 1, tl.cex = 0.7, title = "Home Prices", mar=c(0,0,1,0))

```

#Ranger - Random Forest

```{r}
features <- setdiff(names(trainbaked1), "SalePrice")

model1<- ranger(
  formula   = SalePrice ~ ., 
    data      = trainbaked1, 
    num.trees = 500,
    mtry      = floor(length(features) / 3)
)

print(model1)

```

##RandomForest Random Forest

```{r}
model2 <- randomForest(SalePrice ~ ., data = trainbaked1, proximity = TRUE)
print(model2)

predictedvalues <- as.data.frame(model2$predicted)


oob.error.data <- data.frame(
  Trees=rep(1:nrow(model2$err.rate), times=3),
  Type=rep(c("OOB"), each=nrow(model2$err.rate)),
  Error=c(model2$err.rate[,"OOB"]
    # model2$err.rate[,"Healthy"], 
    # model2$err.rate[,"Unhealthy"]
    )
  )

ggplot(data=oob.error.data, aes(x=Trees, y=Error)) +
  geom_line(aes(color=Type))




```

#Fullset Random Forest Imput Data

```{r}


data.imputed <- rfImpute(SalePrice ~ .,data = fullset, iter = 6)

```

#Random Forest FullSet

```{r}

model3 <- randomForest(SalePrice ~ ., data = data.imputed, proximity = TRUE)

```



```{r}
print(model3)
```


```{r}
navalues <- as.data.frame(map_df(fullset, function(x) sum(is.na(x)))) 

write.csv(fullset, "C:/Users/asbru/Documents/Emory/Forecasting and Predictive Analytics/Final/fullset.csv")
write.csv(data.imputed, "C:/Users/asbru/Documents/Emory/Forecasting and Predictive Analytics/Final/imputed.csv")
write.csv(navalues, "C:/Users/asbru/Documents/Emory/Forecasting and Predictive Analytics/Final/navalues.csv")

```

